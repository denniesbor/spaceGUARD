(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function l(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(e){if(e.ep)return;e.ep=!0;const r=l(e);fetch(e.href,r)}})();let h;function T(){return h=new google.maps.Map(document.getElementById("map"),{center:{lat:37.7893719,lng:-122.3942},zoom:16,heading:320,tilt:0,mapId:"90f87356969d889c"}),h}function I(){return T()}let s,_=[];function w(t){document.getElementById("ssName").innerText=t.SS_NAME,document.getElementById("ssOperator").innerText=t.SS_OPERATOR,document.getElementById("ssVoltages").innerText=t.SS_VOLTAGE,document.getElementById("lineVoltages").innerText=t.LINE_VOLTS.join(", ")}function y(t,n,l,o){const e=document.getElementById("ssDropdown");s=JSON.parse(e.value);const r={lat:parseFloat(s.lat),lng:parseFloat(s.lon)};w(s),_.forEach(d=>d.setMap(null)),_=[];const c=new google.maps.marker.AdvancedMarkerElement({position:r,map:t});_.push(c),t.setCenter(r),k(s.connected_tl_id,l,o,t)}function O(t,n){new google.maps.StreetViewService().getPanorama({location:t,radius:50},function(o,e){e==="OK"?(n.setPano(o.location.pano),n.setPov({heading:270,pitch:0}),n.setVisible(!0)):(n.setVisible(!1),console.log("Street View data not found for this location."))})}function k(t,n,l,o){n&&n.setMap(null),n=new google.maps.Data;const e=l.filter(r=>t.includes(r.properties.line_id));n.addGeoJson({type:"FeatureCollection",features:e}),n.setMap(o)}function M(t,n){document.getElementById("toggleLines").checked?t.setMap(n):t.setMap(null)}function b(t){let n=0,l=0,o=0,e=0,r=0;t.forEach(u=>{switch(u.getLabel()){case"three_ph_transformer":n++,r++;break;case"single_ph_transformer":l++,r++;break;case"primary_power_line":o++;break;case"sec_power_line":e++;break}});const c={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"MultiPoint",coordinates:t.map(u=>[u.getPosition().lng(),u.getPosition().lat()])},properties:{SS_ID:s.SS_ID,SS_NAME:s.SS_NAME,SS_OPERATOR:s.SS_OPERATOR,SS_TYPE:s.SS_TYPE,SS_VOLTAGE:s.SS_VOLTAGE,connected_tl_id:s.connected_tl_id,LINE_VOLTS:s.LINE_VOLTS,REGION:s.REGION,REGION_ID:s.REGION_ID,threePhaseTransformerCount:n,singlePhaseTransformerCount:l,primaryPowerLineCount:o,secondaryPowerLineCount:e,totalTransformerCount:r,markers:t.map(u=>({type:u.getLabel(),color:u.icon.fillColor}))}}]},d=JSON.stringify(c,null,2),i=new Blob([d],{type:"application/geo+json"}),a=document.createElement("a");a.href=URL.createObjectURL(i),a.download=`${s.REGION}_${s.SS_ID}_${s.lat.toFixed(4)}_${s.lon.toFixed(4)}.geojson`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}let f=[];function R(t){let n={three_ph_transformer:"blue",circuit_breaker:"green",single_ph_transformer:"yellow",primary_power_line:"purple",sec_power_line:"pink",control_building:"brown"};t.addListener("click",function(o){const e={lat:o.latLng.lat(),lng:o.latLng.lng()};let r=document.querySelector(".marker.selected");if(r){let c=n[r.id],d=r.id,i=new google.maps.Marker({position:e,map:t,draggable:!0,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:c,fillOpacity:1,strokeWeight:0,scale:10},label:d});f.push(i),i.addListener("dragend",function(a){e.lat=a.latLng.lat(),e.lng=a.latLng.lng()}),i.addListener("rightclick",function(){i.setMap(null),f=f.filter(a=>a!==i)})}});let l=document.querySelectorAll(".marker");l.forEach(o=>{o.addEventListener("click",function(){if(this.classList.contains("selected")){l.forEach(e=>{e.classList.add("disabled")});return}l.forEach(e=>e.classList.remove("selected")),this.classList.add("selected")})}),document.getElementById("disableMarkerAddingButton").addEventListener("click",P),document.getElementById("saveMarkers").addEventListener("click",()=>b(f))}function P(){let t=document.getElementById("disableMarkerAddingButton");t.textContent="Done Adding Markers";let n=document.querySelector(".marker.selected");n&&n.classList.remove("selected")}function N(t){[["Rotate Left","rotate",5,google.maps.ControlPosition.LEFT_CENTER],["Rotate Right","rotate",-5,google.maps.ControlPosition.RIGHT_CENTER],["Tilt Down","tilt",5,google.maps.ControlPosition.TOP_CENTER],["Tilt Up","tilt",-5,google.maps.ControlPosition.BOTTOM_CENTER]].forEach(([o,e,r,c])=>{const d=document.createElement("div"),i=document.createElement("button");i.classList.add("ui-button"),i.innerText=`${o}`,i.addEventListener("click",()=>{l(e,r)}),d.appendChild(i),t.controls[c].push(d)});const l=function(o,e){switch(o){case"tilt":t.setTilt(t.getTilt()+e);break;case"rotate":t.setHeading(t.getHeading()+e);break}}}let g,E,p,m,S=[];function C(){g=I(),R(g),N(g),document.getElementById("map").getBoundingClientRect(),E=g.getStreetView(),D(),v(),document.getElementById("regionDropdown").addEventListener("change",L),document.getElementById("ssDropdown").addEventListener("change",()=>y(g,E,m,S)),document.getElementById("toggleLines").addEventListener("change",()=>M(m,g)),g.addListener("click",function(t){const n={lat:t.latLng.lat(),lng:t.latLng.lng()};document.querySelector(".marker.selected")||O(n,E)})}async function D(){let t="https://gist.githubusercontent.com/denniesbor/81dfc2b05d3c7ee0f02dfc20ec15dce8/raw/a9c6c3b0f9fdc604d4884ded950b1d5035c90e22/tm_ss_df_gt_300v.json";try{p=await(await fetch(t)).json(),console.log("Data fetched successfully:"),Array.isArray(p)?A():console.error("Data is not an array:",p)}catch(n){console.error("Error fetching data:",n)}}async function v(){let t="https://gist.githubusercontent.com/denniesbor/f55327cd9a7ba2c7da2725c5b03b17f0/raw/ece03a294a758201597da9c80a50759726425b09/tm_lines_within_ferc.geojson";try{const l=await(await fetch(t)).json();m=new google.maps.Data,m.addGeoJson(l),console.log("Transmission lines fetched successfully:"),S=l.features}catch(n){console.error("Error fetching transmission lines:",n)}}function A(){const t=document.getElementById("regionDropdown"),n=[...new Set(p.map(o=>o.REGION))];n.forEach(o=>{const e=document.createElement("option");e.value=o,e.text=o,t.add(e)});const l=n.includes("PJM")?"PJM":n[0];t.value=l,L()}function L(){const t=document.getElementById("regionDropdown"),n=document.getElementById("ssDropdown");n.innerHTML="";const l=t.value,o=p.filter(e=>e.REGION===l);o.forEach((e,r)=>{const c=document.createElement("option");c.value=JSON.stringify({lat:e.lat,lon:e.lon,SS_ID:e.SS_ID,SS_NAME:e.SS_NAME,SS_OPERATOR:e.SS_OPERATOR,SS_VOLTAGE:e.SS_VOLTAGE,SS_TYPE:e.SS_TYPE,REGION_ID:e.REGION_ID,REGION:e.REGION,connected_tl_id:e.connected_tl_id,LINE_VOLTS:e.LINE_VOLTS}),c.text=`${r+1}) ${e.SS_ID}`,n.add(c)}),o.length>0&&y(g,E,m,S)}function B(){const t=document.createElement("script");t.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNmcV_-6jLeh2T_TzhsnwItqn3ZEAxT4s&loading=async&libraries=drawing,marker&callback=initMap&v=weekly",t.async=!0,t.defer=!0,document.head.appendChild(t)}window.onload=B;window.initMap=C;
